---
title: "IQS022 - Entities event setup"
---

IQS022 is as follows:

Entities event setup

## Reasoning

Entities can be setup to listen directly to events coming from the library.
In order to do this correctly, the entities should subscribe to the events in `async_added_to_hass`.
And to avoid memory leaks, the entities should unsubscribe from the events in `async_will_remove_from_hass`.

## Example implementation

In the example below, the `self.client.events.subscribe` returns a function that when called, unsubscribes the entity from the event.
So we subscribe to the event in `async_added_to_hass` and unsubscribe in `async_will_remove_from_hass`.

`sensor.py`
```python
class MySensor(SensorEntity):
    """Representation of a sensor."""
    
    unsubscribe: Callable[[], None] = None

    def __init__(self, client: MyClient) -> None:
        """Initialize the sensor."""
        self.client = client
    
    async def async_added_to_hass(self) -> None:
        """Subscribe to the events."""
        await super().async_added_to_hass()
        self.unsubscribe = self.client.events.subscribe("my_event", self._handle_event)
    
    async def async_will_remove_from_hass(self) -> None:
        """Unsubscribe from the events."""
        if self.unsubscribe:
            self.unsubscribe()
        await super().async_will_remove_from_hass()
    
    async def _handle_event(self, event: Event) -> None:
        """Handle the event."""
        ...
```

:::info
The above example can be simplified using lifecycle functions.
This saves the need to store the callback function in the entity.
```python
    async def async_added_to_hass(self) -> None:
        """Subscribe to the events."""
        await super().async_added_to_hass()
        self.async_on_remove(
            self.client.events.subscribe("my_event", self._handle_event)
        )
```
:::

## Additional resources


## Exceptions

There are no exceptions to this rule.

## Related rules

