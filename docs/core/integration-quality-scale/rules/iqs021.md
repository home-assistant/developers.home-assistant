---
title: "IQS021 - Clean up stale devices"
---

IQS021 is as follows:

Clean up stale devices

## Reasoning

When a device is removed from a hub or account, it should also be removed from Home Assistant.
This way, the user interface will not show devices that are no longer available.

We should only remove devices that we are sure are no longer available.

## Example implementation

In this example, we have a coordinator that fetches data from a service.
When the data is updated, we check if any devices have been removed.
If so, we remove them from the device registry.
This also causes all entities associated with the device to be removed.

`coordinator.py`
```python
class MyCoordinator(DataUpdateCoordinator[dict[str, MyDevice]]):
    """Class to manage fetching data."""

    def __init__(self, hass: HomeAssistant, client: MyClient) -> None:
        """Initialize coordinator."""
        super().__init__(
            hass,
            logger=LOGGER,
            name=DOMAIN,
            update_interval=timedelta(minutes=1),
        )
        self.client = client
        self.previous_devices: set[str] = set()

    async def _async_update_data(self) -> dict[str, MyDevice]:
        try:
            data = await self.client.get_data()
        except MyException as ex:
            raise UpdateFailed(f"The service is unavailable: {ex}")
        current_devices = set(data.keys())
        if (old_devices := self.previous_devices - current_devices):
            device_registry = dr.async_get(self.hass)
            for device_id in old_devices:
                device = device_registry.async_get(identifiers={(DOMAIN, device_id)})
                if device:
                    device_registry.async_remove_device(device.id)
            self.previous_devices = current_devices
        return data
```

## Additional resources

For more info on devices, checkout the [device registry documentation](../../../device_registry_index).

## Exceptions

There are no exceptions to this rule.

## Related rules

- IQS033 - Dynamic devices